FROM maven:3.8.3-openjdk-17-slim AS build
WORKDIR /app

ARG VAULT_TOKEN
ENV VAULT_TOKEN=$VAULT_TOKEN

COPY pom.xml .
COPY src ./src

RUN mvn clean package -DskipTests

FROM openjdk:17.0.1-jdk-slim

WORKDIR /app

COPY --from=build /app/target/appointmed-*.jar ./

ARG VAULT_TOKEN
ARG VAULT_URL
ARG KEYCLOAK_URL
ARG KEYCLOAK_APPOINTMED_REALM
ARG KEYCLOAK_APPOINTMED_CLIENTID
ARG MONGODB_HOST
ARG MONGODB_PORT
ARG MONGODB_DATABASE
ARG SMTP_HOST
ARG SMTP_PORT
ARG SMTP_USERNAME
ARG GOOGLE_OAUTH2_CLIENTID

ENV VAULT_TOKEN=${VAULT_TOKEN}
ENV VAULT_URL=${VAULT_URL}
ENV KEYCLOAK_URL=${KEYCLOAK_URL}
ENV KEYCLOAK_APPOINTMED_REALM=${KEYCLOAK_APPOINTMED_REALM}
ENV KEYCLOAK_APPOINTMED_CLIENTID=${KEYCLOAK_APPOINTMED_CLIENTID}
ENV MONGODB_HOST=${MONGODB_HOST}
ENV MONGODB_PORT=${MONGODB_PORT}
ENV MONGODB_DATABASE=${MONGODB_DATABASE}
ENV SMTP_HOST=${SMTP_HOST}
ENV SMTP_PORT=${SMTP_PORT}
ENV SMTP_USERNAME=${SMTP_USERNAME}
ENV GOOGLE_OAUTH2_CLIENTID=${GOOGLE_OAUTH2_CLIENTID}

CMD ["sh", "-c", "java -jar -DVAULT_TOKEN=$VAULT_TOKEN -DVAULT_URL=$VAULT_URL -DKEYCLOAK_URL=$KEYCLOAK_URL -DKEYCLOAK_APPOINTMED_REALM=$KEYCLOAK_APPOINTMED_REALM -DKEYCLOAK_APPOINTMED_CLIENTID=$KEYCLOAK_APPOINTMED_CLIENTID -DMONGODB_HOST=$MONGODB_HOST -DMONGODB_PORT=$MONGODB_PORT -DMONGODB_DATABASE=$MONGODB_DATABASE -DSMTP_HOST=$SMTP_HOST -DSMTP_PORT=$SMTP_PORT -DSMTP_USERNAME=$SMTP_USERNAME -DGOOGLE_OAUTH2_CLIENTID=$GOOGLE_OAUTH2_CLIENTID appointmed-*.jar"]
